#:kivy 2.1.0
#:import rgba kivy.utils.rgba
#:import Window kivy.core.window.Window
#:import Clock kivy.clock.Clock
#:import Animation kivy.animation.Animation
#:import MDApp kivymd.app.MDApp
#:import MDBoxLayout kivymd.uix.boxlayout.MDBoxLayout
#:import MDIconButton kivymd.uix.button.MDIconButton
#:import MDFloatingActionButton kivymd.uix.button.MDFloatingActionButton
#:import MDTextField kivymd.uix.textfield.MDTextField
#:import MDLabel kivymd.uix.label.MDLabel
#:import ScrollView kivy.uix.scrollview.ScrollView
#:import ScreenManager kivy.uix.screenmanager.ScreenManager
#:import Screen kivy.uix.screenmanager.Screen
#:import MDCard kivymd.uix.card.MDCard
#:import MDSwitch kivymd.uix.selectioncontrol.MDSwitch
#:import MDDropdownMenu kivymd.uix.menu.MDDropdownMenu
#:import MDDialog kivymd.uix.dialog.MDDialog
#:import MDList kivymd.uix.list.MDList
#:import MDTopAppBar kivymd.uix.toolbar.MDTopAppBar
#:import MDRoundFlatButton kivymd.uix.button.MDRoundFlatButton
#:import MDRectangleFlatButton kivymd.uix.button.MDRectangleFlatButton
#:import MDFlatButton kivymd.uix.button.MDFlatButton

# Purple theme colors
<RootLayout>:
    canvas.before:
        Color:
            rgba: rgba('#1a0d3d')  # Dark purple background
        Rectangle:
            pos: self.pos
            size: self.size

    ScreenManager:
        id: screen_manager

        MainScreen:
            name: 'main'

        ProfileScreen:
            name: 'profile'

        SettingsScreen:
            name: 'settings'

        CallsScreen:
            name: 'calls'

<MainScreen>:
    # Main three-column layout for desktop, responsive for mobile/tablet
    canvas.before:
        Color:
            rgba: rgba('#1a0d3d')
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        id: main_layout
        orientation: 'horizontal'

        # Left Chat List Panel
        MDCard:
            id: chat_list_panel
            orientation: 'vertical'
            size_hint_x: 0.3
            md_bg_color: rgba('#2d1b69')  # Medium purple
            elevation: 4

            # Top toolbar for chat list
            MDTopAppBar:
                id: chat_list_toolbar
                size_hint_y: None
                height: dp(60)
                md_bg_color: rgba('#4a148c')  # Lighter purple
                elevation: 0

                # Hamburger menu button
                MDIconButton:
                    icon: 'menu'
                    size_hint: None, None
                    size: dp(48), dp(48)
                    pos_hint: {'center_y': 0.5}
                    on_release: app.toggle_left_menu()

                # Search button
                MDIconButton:
                    icon: 'magnify'
                    size_hint: None, None
                    size: dp(48), dp(48)
                    pos_hint: {'center_y': 0.5, 'right': 1}
                    on_release: app.open_search()

                # New chat button
                MDFloatingActionButton:
                    icon: 'plus'
                    size_hint: None, None
                    size: dp(56), dp(56)
                    pos_hint: {'center_y': 0.5, 'right': 1}
                    md_bg_color: rgba('#7C4DFF')  # Primary purple
                    on_release: app.create_new_chat()
                    elevation: 8

            # Chat list area
            ScrollView:
                id: chat_list_scroll
                bar_width: dp(4)
                scroll_type: ['bars', 'content']

                MDList:
                    id: chat_list
                    size_hint_y: None
                    height: self.minimum_height

            # Bottom section for personal chat and settings
            MDBoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: dp(120)
                md_bg_color: rgba('#3d2a7a')  # Slightly darker purple

                # Personal chat button
                MDBoxLayout:
                    size_hint_y: None
                    height: dp(60)
                    padding: dp(15)

                    MDIconButton:
                        icon: 'star'
                        size_hint: None, None
                        size: dp(40), dp(40)

                    MDLabel:
                        text: 'Personal'
                        font_style: 'Body1'
                        theme_text_color: 'Custom'
                        text_color: 1, 1, 1, 1

                    MDIconButton:
                        icon: 'chevron-right'
                        size_hint: None, None
                        size: dp(40), dp(40)
                        on_release: app.open_personal_chat()

                # Settings button
                MDBoxLayout:
                    size_hint_y: None
                    height: dp(60)
                    padding: dp(15)

                    MDIconButton:
                        icon: 'cog'
                        size_hint: None, None
                        size: dp(40), dp(40)

                    MDLabel:
                        text: 'Settings'
                        font_style: 'Body1'
                        theme_text_color: 'Custom'
                        text_color: 1, 1, 1, 1

<ProfileScreen>:
    name: 'profile'
    canvas.before:
        Color:
            rgba: rgba('#1a0d3d')
        Rectangle:
            pos: self.pos
            size: self.size

    MDBoxLayout:
        orientation: 'vertical'

        MDTopAppBar:
            title: 'Profile'
            md_bg_color: rgba('#4a148c')
            elevation: 4
            left_action_items: [['arrow-left', lambda x: app.go_back()]]

        ScrollView:
            MDBoxLayout:
                orientation: 'vertical'
                padding: dp(20)
                spacing: dp(15)

                MDLabel:
                    text: 'Profile Screen'
                    font_style: 'H4'
                    theme_text_color: 'Custom'
                    text_color: 1, 1, 1, 1
                    halign: 'center'

<SettingsScreen>:
    name: 'settings'
    canvas.before:
        Color:
            rgba: rgba('#1a0d3d')
        Rectangle:
            pos: self.pos
            size: self.size

    MDBoxLayout:
        orientation: 'vertical'

        # Header
        MDTopAppBar:
            title: 'Settings'
            md_bg_color: rgba('#4a148c')
            elevation: 4
            left_action_items: [['arrow-left', lambda x: app.go_back()]]

        ScrollView:
            bar_width: dp(4)
            scroll_type: ['bars', 'content']

            MDBoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                padding: dp(20)
                spacing: dp(15)

                # My Account Section
                MDBoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: dp(200)
                    md_bg_color: rgba('#2d1b69')
                    padding: dp(15)
                    spacing: dp(10)
                    radius: [dp(10), dp(10), dp(10), dp(10)]

                    MDLabel:
                        text: 'My Account'
                        font_style: 'H6'
                        theme_text_color: 'Custom'
                        text_color: 1, 1, 1, 1

                    # Profile picture and name
                    MDBoxLayout:
                        spacing: dp(15)

                        MDIconButton:
                            icon: 'account-circle'
                            size_hint: None, None
                            size: dp(60), dp(60)
                            md_bg_color: rgba('#7C4DFF')

                        MDBoxLayout:
                            orientation: 'vertical'
                            spacing: dp(5)

                            MDTextField:
                                hint_text: 'Name'
                                text: 'User Name'
                                size_hint_y: None
                                height: dp(40)

                            MDTextField:
                                hint_text: 'Username'
                                text: '@username'
                                size_hint_y: None
                                height: dp(40)

                # Notifications Section
                MDBoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: dp(250)
                    md_bg_color: rgba('#2d1b69')
                    padding: dp(15)
                    spacing: dp(10)
                    radius: [dp(10), dp(10), dp(10), dp(10)]

                    MDLabel:
                        text: 'Notifications and Sounds'
                        font_style: 'H6'
                        theme_text_color: 'Custom'
                        text_color: 1, 1, 1, 1

                    # Notification settings
                    MDBoxLayout:
                        size_hint_y: None
                        height: dp(50)

                        MDLabel:
                            text: 'Message notifications'
                            font_style: 'Body1'
                            theme_text_color: 'Custom'
                            text_color: 1, 1, 1, 1

                        MDSwitch:
                            active: True

                    MDBoxLayout:
                        size_hint_y: None
                        height: dp(50)

                        MDLabel:
                            text: 'Show preview'
                            font_style: 'Body1'
                            theme_text_color: 'Custom'
                            text_color: 1, 1, 1, 1

                        MDSwitch:
                            active: True

                    MDBoxLayout:
                        size_hint_y: None
                        height: dp(50)

                        MDLabel:
                            text: 'Sound'
                            font_style: 'Body1'
                            theme_text_color: 'Custom'
                            text_color: 1, 1, 1, 1

                        MDSwitch:
                            active: True

                # Privacy Section
                MDBoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: dp(300)
                    md_bg_color: rgba('#2d1b69')
                    padding: dp(15)
                    spacing: dp(10)
                    radius: [dp(10), dp(10), dp(10), dp(10)]

                    MDLabel:
                        text: 'Privacy and Security'
                        font_style: 'H6'
                        theme_text_color: 'Custom'
                        text_color: 1, 1, 1, 1

                    MDBoxLayout:
                        size_hint_y: None
                        height: dp(50)

                        MDLabel:
                            text: 'Last seen'
                            font_style: 'Body1'
                            theme_text_color: 'Custom'
                            text_color: 1, 1, 1, 1

                        MDLabel:
                            text: 'Everyone'
                            font_style: 'Body2'
                            theme_text_color: 'Custom'
                            text_color: 0.7, 0.7, 0.7, 1

                    MDBoxLayout:
                        size_hint_y: None
                        height: dp(50)

                        MDLabel:
                            text: 'Read receipts'
                            font_style: 'Body1'
                            theme_text_color: 'Custom'
                            text_color: 1, 1, 1, 1

                        MDSwitch:
                            active: True

                    MDBoxLayout:
                        size_hint_y: None
                        height: dp(50)

                        MDLabel:
                            text: 'App lock'
                            font_style: 'Body1'
                            theme_text_color: 'Custom'
                            text_color: 1, 1, 1, 1

                        MDSwitch:
                            active: False

                # Data and Storage Section
                MDBoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: dp(200)
                    md_bg_color: rgba('#2d1b69')
                    padding: dp(15)
                    spacing: dp(10)
                    radius: [dp(10), dp(10), dp(10), dp(10)]

                    MDLabel:
                        text: 'Data and Storage'
                        font_style: 'H6'
                        theme_text_color: 'Custom'
                        text_color: 1, 1, 1, 1

                    MDRoundFlatButton:
                        text: 'Clear Cache'
                        size_hint_x: 1
                        size_hint_y: None
                        height: dp(40)
                        on_release: app.clear_cache()

                    MDRoundFlatButton:
                        text: 'Export Data'
                        size_hint_x: 1
                        size_hint_y: None
                        height: dp(40)
                        on_release: app.export_data()

                # About Section
                MDBoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: dp(150)
                    md_bg_color: rgba('#2d1b69')
                    padding: dp(15)
                    spacing: dp(10)
                    radius: [dp(10), dp(10), dp(10), dp(10)]

                    MDLabel:
                        text: 'About'
                        font_style: 'H6'
                        theme_text_color: 'Custom'
                        text_color: 1, 1, 1, 1

                    MDLabel:
                        text: 'Version 1.0.0'
                        font_style: 'Body2'
                        theme_text_color: 'Custom'
                        text_color: 0.7, 0.7, 0.7, 1

                    MDRoundFlatButton:
                        text: 'Send Feedback'
                        size_hint_x: 1
                        size_hint_y: None
                        height: dp(40)
                        on_release: app.send_feedback()

<CallsScreen>:
    name: 'calls'
    canvas.before:
        Color:
            rgba: rgba('#1a0d3d')
        Rectangle:
            pos: self.pos
            size: self.size

    MDBoxLayout:
        orientation: 'vertical'

        MDTopAppBar:
            title: 'Calls'
            md_bg_color: rgba('#4a148c')
            elevation: 4
            left_action_items: [['arrow-left', lambda x: app.go_back()]]

        ScrollView:
            MDList:
                id: calls_list

    # Left Navigation Menu (overlay) - moved to Python code